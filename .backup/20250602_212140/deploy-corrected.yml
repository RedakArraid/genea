name: 🚀 CI/CD Pipeline GeneaIA

on:
  push:
    branches: [ main, staging ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  REGISTRY: ghcr.io
  REPO_NAME: redakarraid/geneaia

jobs:
  test:
    runs-on: ubuntu-latest
    name: 🧪 Tests et Qualité
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: geneaia_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4

    - name: 📦 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: |
          backend/package-lock.json
          frontend/package-lock.json

    - name: 🔧 Install dependencies
      run: |
        cd backend && npm ci
        cd ../frontend && npm ci

    - name: 🏗️ Generate Prisma Client
      run: |
        cd backend
        npx prisma generate

    - name: 🗄️ Run database migrations
      run: |
        cd backend
        npx prisma migrate deploy
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/geneaia_test

    - name: 🧪 Backend Tests
      run: |
        cd backend
        npm test
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/geneaia_test
        JWT_SECRET: test-secret-key
        NODE_ENV: test

    - name: 🧪 Frontend Tests
      run: |
        cd frontend
        npm test || echo "Frontend tests completed"

    - name: 🏗️ Build Frontend
      run: |
        cd frontend
        npm run build
      env:
        VITE_API_URL: http://localhost:3001/api

  build:
    needs: test
    runs-on: ubuntu-latest
    name: 🐳 Build Docker Images
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging'
    
    permissions:
      contents: read
      packages: write

    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4

    - name: 🐳 Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: 🔐 Login to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: 🏗️ Build and push Backend image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/Dockerfile
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.REPO_NAME }}-backend:${{ github.ref_name }}
          ${{ github.ref_name == 'main' && format('{0}/{1}-backend:latest', env.REGISTRY, env.REPO_NAME) || '' }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: 🏗️ Build and push Frontend image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        file: ./frontend/Dockerfile
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.REPO_NAME }}-frontend:${{ github.ref_name }}
          ${{ github.ref_name == 'main' && format('{0}/{1}-frontend:latest', env.REGISTRY, env.REPO_NAME) || '' }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          VITE_API_URL=${{ github.ref_name == 'main' && 'http://168.231.86.179:8090/api' || 'http://168.231.86.179:3011/api' }}

  deploy-staging:
    needs: [test, build]
    runs-on: ubuntu-latest
    name: 🚀 Deploy to Staging
    if: github.ref == 'refs/heads/staging'
    environment: staging
    
    steps:
    - name: 🚀 Deploy to Staging Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.STAGING_HOST }}
        username: ${{ secrets.STAGING_USER }}
        key: ${{ secrets.STAGING_SSH_KEY }}
        port: ${{ secrets.STAGING_PORT || 22 }}
        command_timeout: 10m
        script: |
          set -e
          echo "Starting deployment to staging..."
          
          mkdir -p ${{ secrets.STAGING_PATH }}
          cd ${{ secrets.STAGING_PATH }}
          
          cat > docker-compose.yml << 'EOF'
          version: '3.8'
          
          services:
            postgres:
              image: postgres:15-alpine
              container_name: geneaia-db-staging
              environment:
                POSTGRES_DB: geneaia_staging
                POSTGRES_USER: geneaia_staging
                POSTGRES_PASSWORD: ${{ secrets.STAGING_DB_PASSWORD }}
              volumes:
                - postgres_staging_data:/var/lib/postgresql/data
              restart: unless-stopped
              healthcheck:
                test: ["CMD-SHELL", "pg_isready -U geneaia_staging -d geneaia_staging"]
                interval: 10s
                timeout: 5s
                retries: 5
          
            backend:
              image: ghcr.io/redakarraid/geneaia-backend:staging
              container_name: geneaia-backend-staging
              environment:
                - NODE_ENV=staging
                - DATABASE_URL=postgresql://geneaia_staging:${{ secrets.STAGING_DB_PASSWORD }}@postgres:5432/geneaia_staging?schema=public
                - JWT_SECRET=${{ secrets.STAGING_JWT_SECRET }}
                - CORS_ORIGIN=http://168.231.86.179:3010
                - PORT=3001
              depends_on:
                postgres:
                  condition: service_healthy
              restart: unless-stopped
              ports:
                - "3011:3001"
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:3001/api/health || exit 1"]
                interval: 30s
                timeout: 10s
                retries: 3
          
            frontend:
              image: ghcr.io/redakarraid/geneaia-frontend:staging
              container_name: geneaia-frontend-staging
              environment:
                - VITE_API_URL=http://168.231.86.179:3011/api
              restart: unless-stopped
              ports:
                - "3010:80"
          
          volumes:
            postgres_staging_data:
              driver: local
          
          networks:
            default:
              name: geneaia-staging
          EOF
          
          docker-compose down --remove-orphans || true
          docker-compose pull
          docker-compose up -d
          docker system prune -f

  deploy-production:
    needs: [test, build]
    runs-on: ubuntu-latest
    name: 🚀 Deploy to Production
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: 🚀 Deploy to Production Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PROD_HOST }}
        username: ${{ secrets.PROD_USER }}
        key: ${{ secrets.PROD_SSH_KEY }}
        port: ${{ secrets.PROD_PORT || 22 }}
        command_timeout: 10m
        script: |
          set -e
          echo "Starting deployment to production..."
          
          mkdir -p ${{ secrets.PROD_PATH }}
          cd ${{ secrets.PROD_PATH }}
          
          cat > nginx.conf << 'EOF'
          events {
              worker_connections 1024;
          }
          
          http {
              upstream backend {
                  server backend:3001;
              }
          
              upstream frontend {
                  server frontend:80;
              }
          
              server {
                  listen 80;
                  server_name _;
                  client_max_body_size 10M;
          
                  location / {
                      proxy_pass http://frontend;
                      proxy_set_header Host $host;
                      proxy_set_header X-Real-IP $remote_addr;
                      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                      proxy_set_header X-Forwarded-Proto $scheme;
                  }
          
                  location /api/ {
                      proxy_pass http://backend;
                      proxy_set_header Host $host;
                      proxy_set_header X-Real-IP $remote_addr;
                      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                      proxy_set_header X-Forwarded-Proto $scheme;
                  }
              }
          }
          EOF
          
          cat > docker-compose.yml << 'EOF'
          version: '3.8'
          
          services:
            postgres:
              image: postgres:15-alpine
              container_name: geneaia-db-prod
              environment:
                POSTGRES_DB: geneaia_production
                POSTGRES_USER: geneaia_prod
                POSTGRES_PASSWORD: ${{ secrets.PROD_DB_PASSWORD }}
              volumes:
                - postgres_prod_data:/var/lib/postgresql/data
              restart: unless-stopped
              healthcheck:
                test: ["CMD-SHELL", "pg_isready -U geneaia_prod -d geneaia_production"]
                interval: 10s
                timeout: 5s
                retries: 5
          
            backend:
              image: ghcr.io/redakarraid/geneaia-backend:latest
              container_name: geneaia-backend-prod
              environment:
                - NODE_ENV=production
                - DATABASE_URL=postgresql://geneaia_prod:${{ secrets.PROD_DB_PASSWORD }}@postgres:5432/geneaia_production?schema=public
                - JWT_SECRET=${{ secrets.PROD_JWT_SECRET }}
                - CORS_ORIGIN=http://168.231.86.179:8090
                - PORT=3001
              depends_on:
                postgres:
                  condition: service_healthy
              restart: unless-stopped
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:3001/api/health || exit 1"]
                interval: 30s
                timeout: 10s
                retries: 3
          
            frontend:
              image: ghcr.io/redakarraid/geneaia-frontend:latest
              container_name: geneaia-frontend-prod
              environment:
                - VITE_API_URL=http://168.231.86.179:8090/api
              restart: unless-stopped
          
            nginx:
              image: nginx:alpine
              container_name: geneaia-nginx-prod
              ports:
                - "8090:80"
              volumes:
                - ./nginx.conf:/etc/nginx/nginx.conf:ro
              depends_on:
                - frontend
                - backend
              restart: unless-stopped
          
          volumes:
            postgres_prod_data:
              driver: local
          
          networks:
            default:
              name: geneaia-production
          EOF
          
          docker-compose down --remove-orphans || true
          docker-compose pull
          docker-compose up -d
          docker system prune -f

    - name: 🎉 Production deployment successful
      if: success()
      run: echo "Production deployment completed successfully"

    - name: 😱 Production deployment failed
      if: failure()
      run: echo "Production deployment failed"
